<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Divine Path Kundli with Analysis & Download</title>
<style>
  body {
    font-family: 'Poppins', sans-serif;
    background: #000;
    color: #fdd835;
    margin: 0; padding: 20px; user-select:none;
  }
  h1, h2 {
    text-align: center;
    margin-bottom: 12px;
    text-shadow: 0 0 20px #ffea4d;
  }
  form {
    max-width: 650px;
    background: #111;
    margin: auto;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 0 35px #fdd835aa;
  }
  label {
    font-weight: 600;
    display: block;
    margin: 12px 0 6px;
  }
  select, input, button {
    width: 100%;
    font-size: 1rem;
    padding: 12px;
    border-radius: 10px;
    border: none;
    background: #222;
    color: #fdd835;
    box-shadow: inset 0 0 12px #fdd83544;
  }
  button {
    background: #fdd835;
    color: black;
    font-weight: 900;
    margin-top: 20px;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  button:hover {
    background: #ffeb58;
  }
  #kundli-section {
    max-width: 720px;
    background:#111;
    border-radius: 15px;
    margin: 40px auto 60px;
    padding: 18px;
    box-shadow: 0 0 48px #ffed55cc;
  }
  #kundli-svg {
    display: block;
    margin: 0 auto 30px;
    max-width: 650px;
    height: 650px;
    fill: none;
    stroke: #fdd835;
    stroke-width: 2;
  }
  circle.planet {
    fill: #fdd835;
    stroke: #222;
    stroke-width: 1.5;
    cursor: pointer;
    transition: transform 0.3s ease;
  }
  circle.planet:hover {
    fill: #fff949;
    transform: scale(1.4);
  }
  text.planet-label {
    fill: #222;
    font-weight: 700;
    font-size: 14px;
    pointer-events: none;
    user-select:none;
  }
  text.house-label {
    fill: #fdd835cc;
    font-weight: 700;
    font-size: 20px;
    user-select:none;
    text-shadow: 0 0 15px #fef1a9aa;
  }
  #analysis {
    font-size: 1.1rem;
    line-height: 1.5;
    color: #fff764;
    white-space: pre-line;
    min-height: 160px;
  }
  #download-btn {
    display: block;
    margin: 20px auto 0;
    background: #fdd835cc;
    padding: 14px 38px;
    border-radius: 30px;
    font-weight: 900;
    font-size: 1.1rem;
    cursor: pointer;
    color: black;
    box-shadow: 0 0 28px #fddb32cc;
    border: none;
  }
  #download-btn:hover {
    background: #ffea59ee;
    box-shadow: 0 0 38px #ffec66ff;
  }
</style>
</head>
<body>

<h1>Divine Path Kundli Generator</h1>

<form id="input-form" aria-label="Enter birth information to generate Kundli">
  <label for="city-select">Select City or choose Other for device location:</label>
  <select id="city-select" aria-required="true" required>
    <option value="" disabled selected>-- Select City --</option>
    <option value="28.7041,77.1025">Delhi</option>
    <option value="23.9941,85.3636">Hazaribagh</option>
    <option value="23.3441,85.3096">Ranchi</option>
    <option value="22.5726,88.3639">Kolkata</option>
    <option value="other">Other (Use Device Location)</option>
  </select>

  <label for="latitude">Latitude:</label>
  <input type="number" id="latitude" step="0.0001" required readonly placeholder="Auto-filled or enter manually if 'Other'"/>

  <label for="longitude">Longitude:</label>
  <input type="number" id="longitude" step="0.0001" required readonly placeholder="Auto-filled or enter manually if 'Other'"/>

  <label for="dob">Date of Birth:</label>
  <input type="date" id="dob" required />

  <label for="tob">Time of Birth (24h):</label>
  <input type="time" id="tob" required value="12:00" step="60" />

  <button type="submit" id="generate-btn" aria-label="Generate Kundli and Analysis">Generate Kundli</button>
</form>

<section id="kundli-section" aria-live="polite" role="region" aria-label="Generated Kundli and Analysis" hidden>
  <svg id="kundli-svg" role="img" aria-label="North Indian Kundli Chart"></svg>
  <pre id="analysis" aria-live="polite" aria-atomic="true"></pre>
  <button id="download-btn" aria-label="Download Kundli and analysis as PNG">Download Kundli & Analysis</button>
</section>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
  const citySelect = document.getElementById('city-select');
  const latInput = document.getElementById('latitude');
  const lonInput = document.getElementById('longitude');
  const form = document.getElementById('input-form');
  const kundliSvg = document.getElementById('kundli-svg');
  const kundliSection = document.getElementById('kundli-section');
  const analysisEl = document.getElementById('analysis');
  const downloadBtn = document.getElementById('download-btn');

  citySelect.addEventListener('change', () => {
    if (citySelect.value === 'other') {
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
          latInput.value = pos.coords.latitude.toFixed(4);
          lonInput.value = pos.coords.longitude.toFixed(4);
          latInput.readOnly = true;
          lonInput.readOnly = true;
        }, err=>{
          alert('Could not access location. Please input Latitude and Longitude manually.');
          latInput.value = '';
          lonInput.value = '';
          latInput.readOnly = false;
          lonInput.readOnly = false;
        });
      }
      else {
        alert('Geolocation not supported by your browser.');
        latInput.readOnly = false;
        lonInput.readOnly = false;
      }
    }
    else if(citySelect.value){
      const [lat, lon] = citySelect.value.split(',');
      latInput.value = parseFloat(lat).toFixed(4);
      lonInput.value = parseFloat(lon).toFixed(4);
      latInput.readOnly = true;
      lonInput.readOnly = true;
    } else {
      latInput.value = '';
      lonInput.value = '';
      latInput.readOnly = false;
      lonInput.readOnly = false;
    }
  });

  function degToRad(deg){ return (deg * Math.PI) / 180; }
  function radToDeg(rad){ return (rad * 180) / Math.PI; }
  function toJulianDay(Y,M,D,h,m){
    if(M<=2) {
      Y -=1; M +=12;
    }
    const A = Math.floor(Y/100);
    const B = 2 - A + Math.floor(A/4);
    const dayFraction = (h + m/60)/24;
    return Math.floor(365.25 * (Y + 4716)) + Math.floor(30.6001*(M+1)) + D + dayFraction + B -1524.5;
  }

  // Planet calculations - simplified small formula based
  function sunLongitude(JD){
    let n = JD - 2451545.0;
    let L = (280.460 + 0.9856474*n) % 360;
    let g = (357.528 + 0.9856003*n) % 360;
    let gRad = degToRad(g);
    let lam = L + 1.915 * Math.sin(gRad) + 0.020 * Math.sin(2*gRad);
    return (lam + 360) % 360;
  }
  function moonLongitude(JD){
    let n = JD - 2451550.1;
    let L = (218.316 + 13.176396*n) % 360;
    let M = (134.963 + 13.064993*n) % 360;
    let F = (93.272 + 13.22935 * n) % 360;
    let L_rad = degToRad(L);
    let M_rad = degToRad(M);
    let F_rad = degToRad(F);
    let lam = L + 6.289 * Math.sin(M_rad) - 3.0 * Math.sin(L_rad - degToRad(297.85))
      + 1.274 * Math.sin(2*degToRad(L) - M_rad) + 0.658 * Math.sin(2 * L_rad)
      + 0.214 * Math.sin(2 * M_rad) - 0.186 * Math.sin(degToRad(297.85))
      + 0.114 * Math.sin(2 * F_rad);
    return (lam + 360) % 360;
  }

  // Add other planets similarly (mercury, venus, mars, jupiter, saturn)
  function mercuryLongitude(JD) {let n=JD-2451545.0; return (252.25084+4.0923344368*n)%360;}
  function venusLongitude(JD) {let n=JD-2451545.0; return (181.9798+1.6021302244*n)%360;}
  function marsLongitude(JD) {let n=JD-2451545.0; return (355.433+0.5240207766*n)%360;}
  function jupiterLongitude(JD) {let n=JD-2451545.0; return (34.3515+0.083091*n)%360;}
  function saturnLongitude(JD) {let n=JD-2451545.0; return (50.07745+0.0300657*n)%360;}

  function getPlanets(JD){
    return [
      {name:'Sun', longitude:sunLongitude(JD)},
      {name:'Moon', longitude:moonLongitude(JD)},
      {name:'Mars', longitude:marsLongitude(JD)},
      {name:'Mercury', longitude:mercuryLongitude(JD)},
      {name:'Jupiter', longitude:jupiterLongitude(JD)},
      {name:'Venus', longitude:venusLongitude(JD)},
      {name:'Saturn', longitude:saturnLongitude(JD)},
    ];
  }

  function calculateAscendant(JD, lat, lon) {
    const GST = (function(JD){
      const JD0 = Math.floor(JD + 0.5) - 0.5;
      const S = JD0 - 2451545.0;
      const T = S / 36525.0;
      const T0 = 6.697374558 + 2400.051336 * T + 0.000025862 * T*T;
      const UT = (JD - JD0)*24;
      let GST = T0 + UT*1.002737909;
      GST = (GST % 24) * 15;
      return GST < 0 ? GST + 360 : GST;
    })(JD);

    let LST = (GST + lon) % 360;
    if (LST < 0) LST += 360;

    let latRad = degToRad(lat);
    let lstRad = degToRad(LST);
    const epsilon = degToRad(23.4393);

    let asc = Math.atan2(-Math.cos(lstRad), Math.sin(lstRad)*Math.cos(epsilon) - Math.tan(latRad)*Math.sin(epsilon));
    if (asc < 0) asc += 2*Math.PI;
    return radToDeg(asc);
  }

  // Map longitude and ascendant to house 1-12
  function longitudeToHouse(long, asc) {
    let diff = long - asc;
    if(diff < 0) diff += 360;
    return Math.floor(diff/30) + 1;
  }

  const planetSymbols = {
    Sun: "Su", Moon: "Mo", Mars: "Ma", Mercury: "Me", Jupiter: "Ju", Venus: "Ve", Saturn: "Sa"
  };

  function drawKundli(planets, asc) {
    kundliSvg.innerHTML = '';
    const diamond = document.createElementNS("http://www.w3.org/2000/svg","polygon");
    diamond.setAttribute('points','300,20 580,300 300,580 20,300');
    diamond.setAttribute('stroke','#fdd835');
    diamond.setAttribute('stroke-width','2');
    diamond.setAttribute('fill','none');
    kundliSvg.appendChild(diamond);

    // Houses center for planets (x,y)
    const houseCenters = [
      [300,115],[410,180],[470,310],[410,440],
      [300,510],[190,440],[130,310],[190,180],
      [300,300],[355,240],[300,180],[240,240]
    ];

    // Draw house numbers
    for(let i=1;i<=12;i++){
      let t=document.createElementNS("http://www.w3.org/2000/svg","text");
      t.textContent=i;
      t.setAttribute('x',houseCenters[i-1][0]);
      t.setAttribute('y',houseCenters[i-1][1]-20);
      t.setAttribute('fill','#fdd835');
      t.setAttribute('font-weight','700');
      t.setAttribute('font-size','18');
      t.setAttribute('text-anchor','middle');
      kundliSvg.appendChild(t);
    }

    // Organize planets by house
    const housePlanets = {};
    planets.forEach(p=>{
      let house=longitudeToHouse(p.longitude,asc);
      if(!housePlanets[house])housePlanets[house]=[];
      housePlanets[house].push(p);
    });

    // Draw planets
    for(let i=1;i<=12;i++){
      let planets = housePlanets[i] || [];
      let [baseX, baseY] = houseCenters[i-1];
      planets.forEach((p, idx) => {
        let circle=document.createElementNS("http://www.w3.org/2000/svg","circle");
        circle.setAttribute('cx', baseX);
        circle.setAttribute('cy', baseY+idx*24);
        circle.setAttribute('r',12);
        circle.setAttribute('class','planet-circle');
        kundliSvg.appendChild(circle);

        let text=document.createElementNS("http://www.w3.org/2000/svg","text");
        text.textContent=planetSymbols[p.name] || p.name.slice(0,2);
        text.setAttribute('x', baseX);
        text.setAttribute('y', baseY+idx*24 + 5);
        text.setAttribute('text-anchor','middle');
        text.setAttribute('fill','#000');
        text.setAttribute('font-weight','700');
        text.setAttribute('font-size','14');
        kundliSvg.appendChild(text);
      });
    }
  }

  function analyzePlanets(planets, asc) {
    let txt = "Kundli Detailed Analysis:\n\n";
    const signs = ["Aries","Taurus","Gemini","Cancer","Leo","Virgo","Libra","Scorpio","Sagittarius","Capricorn","Aquarius","Pisces"];
    planets.forEach(p=>{
      let house=longitudeToHouse(p.longitude, asc);
      let sign=signs[Math.floor(p.longitude/30)];
      txt += `${planetSymbols[p.name]||p.name}: House ${house}, Sign ${sign}\n`;
      if(p.name === 'Sun' && sign === 'Leo') txt += "- Sun is exalted in Leo: Boosts vitality and leadership.\n";
      if(p.name === 'Moon' && sign === 'Cancer') txt += "- Moon is exalted in Cancer: Emotional strength.\n";
      if(p.name === 'Saturn' && sign === 'Aries') txt += "- Saturn debilitated in Aries: Challenges present; Mantra and remedies advised.\n";
      txt += "\n";
    });
    txt += "Remedies:\n";
    txt += "- Chant mantras for debilitated planets.\n";
    txt += "- Offer charity related to afflicted planet.\n";
    txt += "- Wear appropriate gemstones after expert advice.\n";
    return txt;
  }

  form.addEventListener('submit', e=>{
    e.preventDefault();
    if(!latInput.value || !lonInput.value || !form.dob.value || !form['time-of-birth'].value){
      alert("Please fill all required fields.");
      return;
    }
    const lat = parseFloat(latInput.value);
    const lon = parseFloat(lonInput.value);
    const [Y,M,D] = form.dob.value.split('-').map(Number);
    const [h,m] = form['time-of-birth'].value.split(':').map(Number);
    const JD = toJulianDay(Y,M,D,h,m);
    const planets = getPlanets(JD);
    const asc = calculateAscendant(JD, lat, lon);
    drawKundli(planets, asc);
    analysisEl.textContent = analyzePlanets(planets, asc);
    kundliSection.hidden = false;
    kundliSection.focus();
  });
</script>

</body>
</html>
