<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Simple Kundli Generator</title>
<style>
  body {
    background: black;
    color: #f4d03f;
    font-family: 'Poppins', sans-serif;
    padding: 20px;
    user-select: none;
  }
  h1 {
    text-align: center;
    margin-bottom: 10px;
    text-shadow: 0 0 20px #f4d03f;
  }
  form {
    max-width: 600px;
    margin: auto;
    background: #111;
    padding: 15px;
    border-radius: 12px;
    box-shadow: 0 0 40px #f4d03fbb;
  }
  label {
    display: block;
    margin-bottom: 6px;
    font-weight: 600;
  }
  select, input, button {
    width: 100%;
    padding: 10px;
    margin-bottom: 16px;
    font-size: 1rem;
    border-radius: 10px;
    border: none;
    background: #222;
    color: #f4d03f;
    box-shadow: inset 0 0 10px #f4d03f77;
  }
  button {
    cursor: pointer;
    font-weight: 700;
    background: #f4d03f;
    color: black;
    box-shadow: 0 0 20px #f4d03faa;
    transition: background 0.3s ease;
  }
  button:hover {
    background: #dab51f;
  }
  #kundli-container {
    max-width: 650px;
    margin: 30px auto;
    background: #111;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 0 60px #dab51fff;
  }
  svg {
    display: block;
    margin: auto;
    max-width: 600px;
    height: 600px;
  }
  .planet-circle {
    fill: #f4d03f;
    stroke: black;
    stroke-width: 1;
    transition: transform 0.3s ease;
  }
  .planet-circle:hover {
    fill: yellow;
    transform: scale(1.3);
  }
  text {
    fill: black;
    font-weight: 700;
    font-size: 14px;
    user-select: none;
  }
  #analysis {
    margin-top: 20px;
    white-space: pre-line;
    color: #f7f7a1;
    font-size: 1rem;
    font-weight: 600;
  }
</style>
</head>
<body>

<h1>Kundli Generator (Demo)</h1>
<form id="kundli-form">
  <label for="city-select">City (select or choose "Other")</label>
  <select id="city-select" required>
    <option value="">-- Select City --</option>
    <option value="28.7041,77.1025">Delhi</option>
    <option value="23.9941,85.3636">Hazaribagh</option>
    <option value="23.3441,85.3096">Ranchi</option>
    <option value="22.5726,88.3639">Kolkata</option>
    <option value="other">Other (Use device location)</option>
  </select>

  <label for="latitude">Latitude</label>
  <input type="number" id="latitude" step="0.0001" readonly required placeholder="Latitude will auto-fill for 'Other'" />

  <label for="longitude">Longitude</label>
  <input type="number" id="longitude" step="0.0001" readonly required placeholder="Longitude will auto-fill for 'Other'" />

  <label for="dob">Date of Birth</label>
  <input type="date" id="dob" required/>

  <label for="tob">Time of Birth (24h)</label>
  <input type="time" id="tob" required value="12:00" step="60"/>

  <button type="submit">Generate Kundli</button>
</form>

<div id="kundli-container" style="display:none;">
  <svg id="kundli-svg" aria-label="Natal Kundli chart"></svg>
  <div id="analysis"></div>
</div>

<script>
  const citySelect = document.getElementById('city-select');
  const latInput = document.getElementById('latitude');
  const lonInput = document.getElementById('longitude');

  citySelect.addEventListener('change', () => {
    if (citySelect.value === 'other') {
      if ('geolocation' in navigator) {
        navigator.geolocation.getCurrentPosition(position => {
          latInput.value = position.coords.latitude.toFixed(4);
          lonInput.value = position.coords.longitude.toFixed(4);
          latInput.readOnly = true;
          lonInput.readOnly = true;
        }, () => {
          alert('Cannot access location. Please fill lat/lon manually.');
          latInput.readOnly = false;
          lonInput.readOnly = false;
          latInput.value = '';
          lonInput.value = '';
        });
      } else {
        alert('Geolocation not supported.');
        latInput.readOnly = false;
        lonInput.readOnly = false;
      }
    } else {
      const [lat, lon] = citySelect.value.split(',');
      latInput.value = parseFloat(lat).toFixed(4);
      lonInput.value = parseFloat(lon).toFixed(4);
      latInput.readOnly = true;
      lonInput.readOnly = true;
    }
  });

  function toJulianDay(y,m,d,h,min){
    if(m <= 2){ y -= 1; m += 12;}
    const A = Math.floor(y/100);
    const B = 2 - A + Math.floor(A/4);
    const dayFrac = (h + min/60)/24;
    return Math.floor(365.25*(y+4716)) + Math.floor(30.6001*(m+1)) + d + dayFrac + B - 1524.5;
  }

  function degToRad(deg) { return deg * Math.PI / 180; }
  function radToDeg(rad) { return rad * 180 / Math.PI; }

  function sunLongitude(JD) {
    const n = JD - 2451545.0;
    const L = (280.460 + 0.9856474 * n) % 360;
    const g = (357.528 + 0.9856003 * n) % 360;
    const gRad = degToRad(g);
    return (L + 1.915 * Math.sin(gRad) + 0.02 * Math.sin(2 * gRad) + 360) % 360;
  }

  function moonLongitude(JD) {
    const n = JD - 2451550.1;
    const L = (218.316 + 13.176396 * n) % 360;
    const M = (134.963 + 13.064993 * n) % 360;
    const F = (93.272 + 13.22935 * n) % 360;
    const LRad = degToRad(L);
    const MRad = degToRad(M);
    const FRad = degToRad(F);
    let lam = L + 6.289 * Math.sin(MRad) - 3.0 * Math.sin(LRad - degToRad(297.85))
               + 1.274 * Math.sin(2 * degToRad(L) - MRad)
               + 0.658 * Math.sin(2 * LRad)
               + 0.214 * Math.sin(2 * MRad)
               - 0.186 * Math.sin(degToRad(297.85))
               + 0.114 * Math.sin(2 * FRad);
    return (lam + 360) % 360;
  }

  function mercuryLongitude(JD) {
    const n = JD - 2451545.0;
    return (252.25084 + 4.0923344368 * n) % 360;
  }

  function venusLongitude(JD) {
    const n = JD - 2451545.0;
    return (181.9798 + 1.6021302244 * n) % 360;
  }

  function marsLongitude(JD) {
    const n = JD - 2451545.0;
    return (355.433 + 0.5240207766 * n) % 360;
  }

  function jupiterLongitude(JD) {
    const n = JD - 2451545.0;
    return (34.3515 + 0.083091 * n) % 360;
  }

  function saturnLongitude(JD) {
    const n = JD - 2451545.0;
    return (50.07745 + 0.0300657 * n) % 360;
  }

  function getPlanets(JD) {
    return [
      { name: 'Sun', longitude: sunLongitude(JD) },
      { name: 'Moon', longitude: moonLongitude(JD) },
      { name: 'Mars', longitude: marsLongitude(JD) },
      { name: 'Mercury', longitude: mercuryLongitude(JD) },
      { name: 'Jupiter', longitude: jupiterLongitude(JD) },
      { name: 'Venus', longitude: venusLongitude(JD) },
      { name: 'Saturn', longitude: saturnLongitude(JD) }
    ];
  }

  function calculateAscendant(JD, lat, lon) {
    let GST = (function(JD) {
      const JD0 = Math.floor(JD + 0.5) - 0.5;
      const S = JD0 - 2451545.0;
      const T = S / 36525.0;
      const T0 = 6.697374558 + 2400.051336 * T + 0.000025862 * T * T;
      const UT = (JD - JD0) * 24;
      let GST = T0 + UT * 1.002737909;
      GST = (GST % 24) * 15;
      if (GST < 0) GST += 360;
      return GST;
    })(JD);
    let LST = (GST + lon) % 360;
    if (LST < 0) LST += 360;
    const radLat = degToRad(lat);
    const radLST = degToRad(LST);
    const epsilon = degToRad(23.4393);
    let asc = Math.atan2(
      -Math.cos(radLST),
      Math.sin(radLST) * Math.cos(epsilon) - Math.tan(radLat) * Math.sin(epsilon)
    );
    if (asc < 0) asc += 2 * Math.PI;
    return radToDeg(asc);
  }

  function longitudeToHouse(lon, asc) {
    let diff = lon - asc;
    if (diff < 0) diff += 360;
    return Math.floor(diff / 30) + 1;
  }

  const planetSymbols = {
    Sun: 'Su', Moon: 'Mo', Mars: 'Ma', Mercury: 'Me',
    Jupiter: 'Ju', Venus: 'Ve', Saturn: 'Sa',
  };

  function drawKundli(planets, asc) {
    const svg = document.getElementById('kundli-svg');
    svg.innerHTML = ''; // Clear existing

    // Diamond
    const diamond = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
    diamond.setAttribute('points', '300,20 580,300 300,580 20,300');
    diamond.setAttribute('stroke', '#f4d03f');
    diamond.setAttribute('stroke-width', '3');
    diamond.setAttribute('fill', 'none');
    svg.appendChild(diamond);

    // House centers (x, y)
    const houseCenters = [
      [300,110], [410,175], [470,310], [410,445],
      [300,510], [190,445], [130,310], [190,175],
      [300,300], [355,235], [300,170], [240,235]
    ];

    // Draw house numbers
    for (let i = 0; i < 12; i++) {
      const houseText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      houseText.textContent = (i + 1);
      houseText.setAttribute('x', houseCenters[i][0]);
      houseText.setAttribute('y', houseCenters[i][1] - 20);
      houseText.setAttribute('text-anchor', 'middle');
      houseText.setAttribute('fill', '#f4d03f');
      houseText.setAttribute('font-size', '18');
      houseText.setAttribute('font-weight', '700');
      svg.appendChild(houseText);
    }

    // Group planets by house
    const housePlanets = {};
    planets.forEach(p => {
      const houseNum = longitudeToHouse(p.longitude, asc);
      if (!housePlanets[houseNum]) housePlanets[houseNum] = [];
      housePlanets[houseNum].push(p);
    });

    // Place planets
    for (let house = 1; house <= 12; house++) {
      let planetsInHouse = housePlanets[house] || [];
      let baseX = houseCenters[house - 1][0];
      let baseY = houseCenters[house - 1][1];
      planetsInHouse.forEach((p, idx) => {
        let circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', baseX);
        circle.setAttribute('cy', baseY + idx * 24);
        circle.setAttribute('r', 12);
        circle.setAttribute('class', 'planet-circle');
        svg.appendChild(circle);

        let text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.textContent = planetSymbols[p.name] || p.name.slice(0, 2);
        text.setAttribute('x', baseX);
        text.setAttribute('y', baseY + idx * 24 + 5);
        text.setAttribute('text-anchor', 'middle');
        text.setAttribute('fill', 'black');
        text.setAttribute('font-size', '12');
        text.setAttribute('font-weight', '700');
        svg.appendChild(text);
      });
    }
  }

  function generateAnalysis(planets, asc) {
    let out = 'Kundli Analysis:\n\n';

    planets.forEach(p => {
      const house = longitudeToHouse(p.longitude, asc);
      const sign = SIGNS[Math.floor(p.longitude / 30)];
      out += `${planetSymbols[p.name]||p.name}: House ${house}, Sign ${sign}\n`;

      // Example conditions
      if (p.name === 'Sun' && sign === 'Leo')
        out += '- Sun is exalted in Leo: Strong leadership and vitality.\n';
      if (p.name === 'Moon' && sign === 'Cancer')
        out += '- Moon exalted in Cancer: Emotional strength and intuition.\n';
      if (p.name === 'Saturn' && sign === 'Aries')
        out += '- Saturn debilitated in Aries: Challenges with discipline.\nRemedy: Chant Shani Mantra daily.\n';
    });
    return out;
  }

  const SIGNS = ["Aries", "Taurus", "Gemini", "Cancer", "Leo", "Virgo", "Libra", "Scorpio", "Sagittarius", "Capricorn", "Aquarius", "Pisces"];

  kundliForm.addEventListener('submit', e => {
    e.preventDefault();
    const lat = parseFloat(latInput.value);
    const lon = parseFloat(lonInput.value);
    const dob = document.getElementById('dob').value;
    const tob = document.getElementById('tob').value;
    if(!lat || !lon || !dob || !tob) {
      alert('Please fill all fields');
      return;
    }
    const [Y, M, D] = dob.split('-').map(Number);
    const [h, m] = tob.split(':').map(Number);

    const JD = toJulianDay(Y,M,D,h,m);
    const planets = getPlanets(JD);
    const asc = calculateAscendant(JD, lat, lon);

    drawKundli(planets, asc);
    analysis.textContent = generateAnalysis(planets, asc);
    kundliContainer.style.display = 'block';
  });
</script>

</body>
</html>
